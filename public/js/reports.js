/**
 * Sistema de Relat√≥rios - WiFi Tocantins
 * JavaScript para funcionalidades avan√ßadas dos relat√≥rios
 */

class ReportsManager {
    constructor() {
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.setupDateValidation();
        this.setupAutoRefresh();
        this.setupFilterPresets();
    }

    setupEventListeners() {
        // Auto-aplicar filtros quando mudar datas
        const dateInputs = document.querySelectorAll('input[type="date"]');
        dateInputs.forEach(input => {
            input.addEventListener('change', () => {
                this.validateDateRange();
            });
        });

        // Filtros r√°pidos
        const quickFilters = document.querySelectorAll('[data-quick-filter]');
        quickFilters.forEach(filter => {
            filter.addEventListener('click', (e) => {
                e.preventDefault();
                this.applyQuickFilter(filter.dataset.quickFilter);
            });
        });

        // Exporta√ß√£o com confirma√ß√£o
        const exportLinks = document.querySelectorAll('a[href*="export"]');
        exportLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                if (!this.confirmExport()) {
                    e.preventDefault();
                }
            });
        });
    }

    setupDateValidation() {
        const startDateInput = document.querySelector('input[name="start_date"]');
        const endDateInput = document.querySelector('input[name="end_date"]');
        
        if (startDateInput && endDateInput) {
            startDateInput.addEventListener('change', () => {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                
                if (startDate > endDate) {
                    endDateInput.value = startDateInput.value;
                    this.showNotification('Data final ajustada para n√£o ser anterior √† data inicial', 'warning');
                }
                
                this.checkDateRange();
            });

            endDateInput.addEventListener('change', () => {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                
                if (endDate < startDate) {
                    startDateInput.value = endDateInput.value;
                    this.showNotification('Data inicial ajustada para n√£o ser posterior √† data final', 'warning');
                }
                
                this.checkDateRange();
            });
        }
    }

    checkDateRange() {
        const startDateInput = document.querySelector('input[name="start_date"]');
        const endDateInput = document.querySelector('input[name="end_date"]');
        
        if (startDateInput && endDateInput) {
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays > 365) {
                this.showNotification('Per√≠odo muito longo! Relat√≥rios com mais de 1 ano podem ser lentos.', 'warning');
            }
        }
    }

    validateDateRange() {
        const startDateInput = document.querySelector('input[name="start_date"]');
        const endDateInput = document.querySelector('input[name="end_date"]');
        
        if (startDateInput && endDateInput) {
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            
            if (startDate > endDate) {
                this.showNotification('Data inicial n√£o pode ser posterior √† data final', 'error');
                return false;
            }
        }
        return true;
    }

    setupAutoRefresh() {
        // Auto-refresh apenas se estiver na aba ativa e per√≠odo for hoje
        const startDateInput = document.querySelector('input[name="start_date"]');
        const endDateInput = document.querySelector('input[name="end_date"]');
        
        if (startDateInput && endDateInput) {
            const today = new Date().toISOString().split('T')[0];
            
            if (startDateInput.value === today && endDateInput.value === today) {
                this.startAutoRefresh();
            }
        }
    }

    startAutoRefresh() {
        // Refresh a cada 5 minutos se for dados de hoje
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                const today = new Date().toISOString().split('T')[0];
                const startDate = document.querySelector('input[name="start_date"]').value;
                const endDate = document.querySelector('input[name="end_date"]').value;
                
                if (startDate === today && endDate === today) {
                    this.refreshCurrentData();
                }
            }
        }, 300000); // 5 minutos
    }

    refreshCurrentData() {
        // Evitar refresh se gr√°ficos est√£o sendo renderizados
        if (document.querySelector('canvas[style*="block"]')) {
            console.log('Charts are rendering, skipping refresh');
            return;
        }
        
        // Recarregar apenas os cards de estat√≠sticas sem refresh da p√°gina
        this.showNotification('Atualizando dados...', 'info');
        
        // Simular atualiza√ß√£o (implementar AJAX quando necess√°rio)
        setTimeout(() => {
            this.showNotification('Dados atualizados!', 'success');
        }, 1000);
    }

    setupFilterPresets() {
        // Criar bot√µes de filtros r√°pidos se n√£o existirem
        this.createQuickFilterButtons();
    }

    createQuickFilterButtons() {
        const filterContainer = document.querySelector('.space-y-4');
        if (!filterContainer || document.querySelector('.quick-filters')) return;

        const quickFiltersDiv = document.createElement('div');
        quickFiltersDiv.className = 'quick-filters flex flex-wrap gap-2 p-4 bg-gray-50 rounded-lg';
        quickFiltersDiv.innerHTML = `
            <span class="text-sm font-medium text-gray-700 mr-4">Filtros R√°pidos:</span>
            <button data-quick-filter="today" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs hover:bg-blue-200 transition-colors">
                üìÖ Hoje
            </button>
            <button data-quick-filter="yesterday" class="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-xs hover:bg-gray-200 transition-colors">
                üìÖ Ontem
            </button>
            <button data-quick-filter="week" class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs hover:bg-green-200 transition-colors">
                üìÖ Esta Semana
            </button>
            <button data-quick-filter="month" class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-xs hover:bg-purple-200 transition-colors">
                üìÖ Este M√™s
            </button>
            <button data-quick-filter="paid" class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs hover:bg-green-200 transition-colors">
                ‚úÖ Apenas Pagos
            </button>
            <button data-quick-filter="pending" class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs hover:bg-yellow-200 transition-colors">
                ‚è≥ Apenas Pendentes
            </button>
        `;

        filterContainer.appendChild(quickFiltersDiv);

        // Adicionar event listeners aos novos bot√µes
        const quickFilters = quickFiltersDiv.querySelectorAll('[data-quick-filter]');
        quickFilters.forEach(filter => {
            filter.addEventListener('click', (e) => {
                e.preventDefault();
                this.applyQuickFilter(filter.dataset.quickFilter);
            });
        });
    }

    applyQuickFilter(filterType) {
        const today = new Date();
        const startDateInput = document.querySelector('input[name="start_date"]');
        const endDateInput = document.querySelector('input[name="end_date"]');
        const paymentStatusSelect = document.querySelector('select[name="payment_status"]');
        const userStatusSelect = document.querySelector('select[name="user_status"]');

        // Reset status filters first
        if (paymentStatusSelect) paymentStatusSelect.value = 'all';
        if (userStatusSelect) userStatusSelect.value = 'all';

        switch (filterType) {
            case 'today':
                const todayStr = today.toISOString().split('T')[0];
                startDateInput.value = todayStr;
                endDateInput.value = todayStr;
                break;

            case 'yesterday':
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                startDateInput.value = yesterdayStr;
                endDateInput.value = yesterdayStr;
                break;

            case 'week':
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());
                startDateInput.value = startOfWeek.toISOString().split('T')[0];
                endDateInput.value = today.toISOString().split('T')[0];
                break;

            case 'month':
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                startDateInput.value = startOfMonth.toISOString().split('T')[0];
                endDateInput.value = today.toISOString().split('T')[0];
                break;

            case 'paid':
                if (paymentStatusSelect) paymentStatusSelect.value = 'completed';
                break;

            case 'pending':
                if (paymentStatusSelect) paymentStatusSelect.value = 'pending';
                break;
        }

        // Auto-submit form after applying filter
        setTimeout(() => {
            const form = document.querySelector('form');
            if (form) {
                this.showNotification(`Filtro "${this.getFilterName(filterType)}" aplicado`, 'success');
                form.submit();
            }
        }, 100);
    }

    getFilterName(filterType) {
        const names = {
            'today': 'Hoje',
            'yesterday': 'Ontem',
            'week': 'Esta Semana',
            'month': 'Este M√™s',
            'paid': 'Apenas Pagos',
            'pending': 'Apenas Pendentes'
        };
        return names[filterType] || filterType;
    }

    confirmExport() {
        const startDate = document.querySelector('input[name="start_date"]').value;
        const endDate = document.querySelector('input[name="end_date"]').value;
        
        return confirm(`Exportar dados do per√≠odo de ${this.formatDate(startDate)} at√© ${this.formatDate(endDate)}?`);
    }

    formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('pt-BR');
    }

    showNotification(message, type = 'info') {
        // Remover notifica√ß√£o existente
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        // Criar nova notifica√ß√£o
        const notification = document.createElement('div');
        notification.className = `notification fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
        
        const colors = {
            'success': 'bg-green-500 text-white',
            'error': 'bg-red-500 text-white',
            'warning': 'bg-yellow-500 text-white',
            'info': 'bg-blue-500 text-white'
        };
        
        notification.className += ` ${colors[type] || colors.info}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Animar entrada
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);
        
        // Remover ap√≥s 3 segundos
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 3000);
    }

    // M√©todo para atualizar gr√°ficos dinamicamente
    updateCharts(data) {
        // Implementar atualiza√ß√£o de gr√°ficos quando necess√°rio
        console.log('Updating charts with new data:', data);
        
        // Evitar conflito com gr√°ficos j√° inicializados
        if (typeof window.initializeCharts === 'function') {
            // Aguardar um pouco antes de reinicializar
            setTimeout(() => {
                window.initializeCharts();
            }, 100);
        }
    }

    // M√©todo para exporta√ß√£o customizada
    customExport(type, format, filters) {
        const params = new URLSearchParams({
            type: type,
            format: format,
            ...filters
        });
        
        const exportUrl = `/admin/reports/export?${params.toString()}`;
        window.location.href = exportUrl;
    }
}

// Inicializar quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    new ReportsManager();
});

// Fun√ß√£o global para compatibilidade
window.ReportsManager = ReportsManager;
