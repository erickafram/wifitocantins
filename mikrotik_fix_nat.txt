# SCRIPT PARA CORRIGIR NAT NO MIKROTIK
# Problema: Site tocantinstransportewifi.com.br não está acessível
# Solução: Reorganizar regras NAT para permitir HTTPS e HTTP antes da regra dinâmica

# 1. PRIMEIRO, VAMOS VER A CONFIGURAÇÃO ATUAL COMPLETA
/ip firewall nat print

# 2. REMOVER REGRAS DUPLICADAS OU MAL POSICIONADAS
# Remover a regra HTTP Redirect que está na posição errada (21)
/ip firewall nat remove [find comment="HTTP Redirect"]

# 3. ADICIONAR REGRAS NA ORDEM CORRETA
# Regra 1: Permitir HTTPS (porta 443) - já existe na posição 0
# Regra 2: Adicionar redirect HTTP (porta 80) ANTES da regra dinâmica
/ip firewall nat add \
    chain=dstnat \
    action=redirect \
    to-ports=64873 \
    protocol=tcp \
    hotspot=from-client \
    dst-port=80 \
    place-before=1 \
    comment="HTTP Redirect to Hotspot"

# 4. ADICIONAR EXCEÇÕES ESPECÍFICAS PARA O DOMÍNIO
# Adicionar regra para permitir acesso direto ao site (bypass hotspot)
/ip firewall nat add \
    chain=dstnat \
    action=accept \
    protocol=tcp \
    dst-address-list=tocantins_wifi \
    dst-port=80,443 \
    place-before=0 \
    comment="Allow Tocantins WiFi Direct"

# 5. CRIAR LISTA DE ENDEREÇOS PARA O SITE
/ip firewall address-list add \
    list=tocantins_wifi \
    address=www.tocantinstransportewifi.com.br \
    comment="Tocantins WiFi Domain"

# 6. VERIFICAR DNS E RESOLVER O DOMÍNIO
/ip firewall address-list add \
    list=tocantins_wifi \
    address=tocantinstransportewifi.com.br \
    comment="Tocantins WiFi Domain without www"

# 7. VERIFICAR A NOVA ORDEM DAS REGRAS
/ip firewall nat print where chain=dstnat

# 8. ADICIONAR REGRA NO HOTSPOT WALLED GARDEN (IMPORTANTE!)
# Isso permite acesso ao site sem autenticação
/ip hotspot walled-garden ip add \
    dst-host="www.tocantinstransportewifi.com.br" \
    action=accept \
    comment="Allow Tocantins WiFi"

/ip hotspot walled-garden ip add \
    dst-host="tocantinstransportewifi.com.br" \
    action=accept \
    comment="Allow Tocantins WiFi without www"

# 9. ADICIONAR REGRAS PARA PERMITIR DNS DO DOMÍNIO
/ip hotspot walled-garden add \
    dst-host="*.tocantinstransportewifi.com.br" \
    action=allow \
    comment="Allow all Tocantins WiFi subdomains"

# 10. LIMPAR CACHE DNS
/ip dns cache flush

# 11. TESTAR CONECTIVIDADE
/tool fetch url="https://www.tocantinstransportewifi.com.br" mode=https as-value
/tool fetch url="http://www.tocantinstransportewifi.com.br" mode=http as-value

# 12. SE AINDA HOUVER PROBLEMAS, VERIFICAR:
# a) Configuração do servidor hotspot
/ip hotspot server print

# b) Perfil do hotspot
/ip hotspot profile print

# c) Verificar se há regras de firewall bloqueando
/ip firewall filter print where chain=forward

# 13. SOLUÇÃO ALTERNATIVA - BYPASS COMPLETO PARA O SITE
# Se nada funcionar, criar bypass completo:
/ip hotspot walled-garden ip add \
    dst-address=104.21.47.186 \
    action=accept \
    comment="Tocantins WiFi IP Direct"

# Nota: Substitua 104.21.47.186 pelo IP real do servidor
# Para descobrir o IP:
/ping www.tocantinstransportewifi.com.br count=1

# 14. REINICIAR SERVIÇO HOTSPOT (SE NECESSÁRIO)
/ip hotspot disable [find]
/delay 2s
/ip hotspot enable [find]

# FIM DO SCRIPT